<!DOCTYPE html>
<html>
<head>
	<title>Chat Room</title>
	<link rel="stylesheet" type="text/css" href="http://ec2-52-89-223-118.us-west-2.compute.amazonaws.com/~bg2crx/stylesheet.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
</head>
<body class="common">
<div class="fullcontainer">
<div class="headtitle">&nbsp;&nbsp; SIGN IN</div>
		<div class="headstrip"></div>
		<div class="bodyblock">
		<div class="bodybox">
			<div id="msgspace"></div><div id="readspace"></div><div id="warnspace"></div><div id="promptspace"></div>
			<form id="loginform" method="POST">
					<input class="login" id="inputusername" type="text" name="userinput" placeholder="User Name..." />&nbsp;
					<input class="login" id="inputpassword" type="password" name="userinputpw" placeholder="Password..." />&nbsp;
					<div class="clickbox" id="loginsubmit">LOGIN</div>&emsp;<div class="clickbox" id="signinsubmit">SIGN UP</div>
			  </form>
		</div>
		<br/><br/><br/><br/>
		<br/><br/><br/><br/>
		<br/><br/><br/><br/>
		<br/><br/><br/><br/>
		<br/><br/><br/><br/>
	  </div>
</div>



<script type="text/javascript">

	
	//shisutemu no kyodo seigyou
	$(window).keydown(function(event){          //disable all regular form submit function
        if((event.keyCode == 13)) {
          event.preventDefault();
        }
    });
	//window.onbeforeunload = function() {
	//	signout();
	//	alert("You have signed out.");
	////logout
	////alert you have log out
	//};
	
	//henryo
var socketio = io.connect();
var username = null;
var listenToHail = null;
var listenToBC = "TC_update";
var listenToMC = null;
var currRoom = null;
var currRoomToken = null;
var currRoomMaster = null;
var VaticanCameos = false;
var allusers = [];
var allrooms = [];
var allperms = [];
var usersinroom = [];
var banlist = [];
var gotoWhere = null;
var gotoWhereIsPublic = null;



/*
socketio.on("message_to_client",function(data) {

});

socketio.emit("message_to_server", {message:msg});

*/

//uketotta~ kaiseki kudasai!


function initOnLoginOK() {
    if (username) {
        genChatSys();
        listenToHail = "Hail_"+username;
        
        socketio.on(listenToHail, function (data) {
            parseUC(data);
        });
        
        socketio.on(listenToBC, function (data) {
            parseBC(data);
        });
        currRoom = "Main Lobby";
        listenToMC = "TR_"+currRoom;            //i found that spaces <i>can</i> be included in the event name how amazing is that!
        socketio.on(listenToMC, function (data) {
            var whatString = '';
            if (data.type === 1) {
                for (var i=0;i<data.rmUserLi.length;i++) {
                    whatString += '<div class="userlistentry userinroomentry"><span class="userinroomname">'+htmlEntities(data.rmUserLi[i])+'</span><span class="inlinert">Msg</span></div>';
                }
                $("#userinroomlist").html(whatString);
                $(".userinroomentry").click(function() {
                    var temp = $('<textarea />').html($(this).children(".userinroomname").text()).text();
                    $("#cbx").prop( "checked", true );
                    $("#mentionwho").val(temp);
                });
            }
            else if (data.type === 2) {
                if (data.roomname === currRoom){
                    whatString += '<div class="chatmsg"><span class="chattext">';
                    whatString += htmlEntities(data.msg);
                    whatString += '</span><span class="chatdatetime">';
                    whatString += htmlEntities(data.datetime);
                    whatString += '</span><span class="chatde">';
                    whatString += htmlEntities(data.de);
                    whatString += '</span>&emsp;<div class="listclickbox pvmsg">Send Msg</div>&nbsp;<div class="listclickbox clip">Clip</div></div>';
                    $(whatString).appendTo(".chatmsgdisp");
                    $(".pvmsg").click(function() {
                        var temp = $('<textarea />').html($(this).siblings(".chatde").text()).text();
                        $("#cbx").prop( "checked", true );
                        $("#mentionwho").val(temp);
                    });
                    $(".clip").click(function() {
                        var putMsg = {
                            msg: $('<textarea />').html($(this).siblings(".chattext").text()).text(),
                            de: $('<textarea />').html($(this).siblings(".chatde").text()).text(),
                            datetime: $('<textarea />').html($(this).siblings(".chatdatetime").text()).text()
                            };
                        genPromptInput(2, 2, putMsg);
                    });
                }
            }
            else {
                if (VaticanCameos) {
                    kinkyuDashutsuPuroguramu();
                }
            }
            //do mc room update stuff
        });
        //multicast listener will be updated on _rinit response
        socketio.emit("TSvr_uinit", {username: username});
    }
    //on signout remove all listeners
}

function tryCreateRm(whatRoomName, isPublic, roomPwd) {
    socketio.emit("TSvr_createRm", {
        username: username,
        roomname: whatRoomName,
        isPublic: isPublic,
        roomPwd: roomPwd
    });
}

function tryGoToRoom(whatRoom, whatPassword) {//5
    socketio.emit("TSvr_tryRm", {
        username: username,
        rmPwd: whatPassword,
        rmName: whatRoom,
        prevRm: currRoom
    });
}

function tryRmInit(whatRoomIsCurrRoom) {
    socketio.emit("TSvr_rinit", {
        username: username,
        roomname: whatRoomIsCurrRoom,
        roomtoken: currRoomToken
    });
}

function trySpeak(whatMsg, isPrivate, to) {
    socketio.emit("TSvr_speak", {
        username: username,
        roomname: currRoom,
        roomtoken: currRoomToken,
        msg: whatMsg,
        isprivate: isPrivate,
        to: to
    });
}

function tryKick(kickWho) {
    socketio.emit("TSvr_kick", {
        username: username,
        roomname: currRoom,
        roomtoken: currRoomToken,
        kickWho: kickWho
    });
}

function tryInvite(inviteWho, whatMsg) {
    socketio.emit("TSvr_invite", {
        username: username,
        roomname: currRoom,
        roomtoken: currRoomToken,
        invitee: inviteWho,
        msg: whatMsg
    });
}

function tryBan(banWho) {
    socketio.emit("TSvr_ban", {
        username: username,
        roomname: currRoom,
        roomtoken: currRoomToken,
        banWho: banWho
    });
}

function tryUnban(unbanWho, whatMsg) {
    socketio.emit("TSvr_unban", {
        username: username,
        roomname: currRoom,
        roomtoken: currRoomToken,
        unbanWho: unbanWho,
        msg: whatMsg
    });
}

function tryGetHisMsg(startAt) {
    socketio.emit("TSvr_history", {
        username: username,
        roomname: currRoom,
        roomtoken: currRoomToken,
        startAt: startAt
    });
}

function tryGetHashMsg(hashtag, startAt) {
    socketio.emit("TSvr_hashtag", {
        username: username,
        roomname: currRoom,
        roomtoken: currRoomToken,
        hashtag: hashtag,
        startAt:startAt
    });
}

function tryGetClipBoard(whatPassword) {
    socketio.emit("TSvr_clipboard_get", {
        username: username,
        password: castToString(whatPassword)
    });
}

function tryPutClipBoard(whatMsg, whatPassword) {
    socketio.emit("TSvr_clipboard_put", {
        username: username,
        password: whatPassword,
        msg: whatMsg.msg,
        de: whatMsg.de,
        datetime: whatMsg.datetime
    });
    
}

function tryRmClipBoard(whatId, whatPassword) {
    socketio.emit("TSvr_clipboard_rm", {
        username: username,
        password: whatPassword,
        id: whatId
    });
}


function setRoomMCListener(oldRoom, newRoom) {
    var oldRmCLG = null;
    var newRmCLG = "TR_"+castToString(newRoom);
    if (oldRoom) {
        oldRmCLG = "TR_"+castToString(oldRoom);
        socketio.removeAllListeners(oldRmCLG);
        listenToMC = null;
    }
    else if (listenToMC) {
        oldRmCLG = listenToMC;
        socketio.removeAllListeners(oldRmCLG);
        listenToMC = null;
    }
    listenToMC = newRmCLG;
    socketio.on(newRmCLG, function (data) {
        parseMC(data);
    });
}



function parseBC(data) {
    allusers = data.userLi;
    allrooms = data.roomLi;
    allperms = data.permLi;
    var whatString = "";
    for (var i=0;i<allusers.length;i++) {
        whatString += '<div class="userlistentry"><span class="userinroomname">'+htmlEntities(allusers[i])+'</span></div>';
    }
    $("#alluserlist").html(whatString);
    whatString = "";
    for (i=0;i<allrooms.length;i++) {
        whatString += '<div class="roomentry"><span class="roomname">'+htmlEntities(allrooms[i])+'</span>';
        if (allperms[i] === 0) {
            whatString += '<span class="pvroom">Private</span>';
        }
        whatString += '</div>';
    }
    $("#roomlist").html(whatString);
    $(".roomentry").click(function() {
        var roomtogo = castToString($(this).children(".roomname").text());
        roomtogo = $('<textarea />').html(roomtogo).text();
        if ($(this).children(".pvroom").length > 0) {       //check if private
            gotoWhereIsPublic = 0;
        }
        else {
            gotoWhereIsPublic = 1;
        }
        if (username === currRoomMaster) {
            gotoWhere = "";
            gotoWhere = roomtogo;
            showWarnBox("Are you sure you want to leave and dismiss the current room?");
            return;
        }
        else {
            if (gotoWhereIsPublic===0) {
                genPromptInput(1, roomtogo, null);
            }
            else {
                tryGoToRoom(roomtogo, null);
                gotoWhere = null;
                gotoWhereIsPublic = null;
            }
        }
    });
}

function parseMC(data) {
    var whatString = "";
    switch (data.type) {
        case 1:     //update
            for (var i=0;i<data.rmUserLi.length;i++) {
                whatString += '<div class="userlistentry userinroomentry"><span class="userinroomname">'+htmlEntities(data.rmUserLi[i])+'</span><span class="inlinert">Msg</span></div>';
            }
            $("#userinroomlist").html(whatString);
            $(".userinroomentry").click(function() {
                var temp = $('<textarea />').html($(this).children(".userinroomname").text()).text();
                $("#cbx").prop( "checked", true );
                $("#mentionwho").val(temp);
            });
            usersinroom = data.rmUserLi;
            whatString = "";
            for (i=0;i<usersinroom.length;i++) {
                whatString += '<option value="'+htmlEntities(usersinroom[i])+'" />';
            }
            $("#mentionwho").html(whatString);
            break;
        case 2:     //msg
            if (data.roomname === currRoom){
                whatString += '<div class="chatmsg"><span class="chattext">';
                whatString += htmlEntities(data.msg);
                whatString += '</span><span class="chatdatetime">';
                whatString += htmlEntities(data.datetime);
                whatString += '</span><span class="chatde">';
                whatString += htmlEntities(data.de);
                whatString += '</span>&emsp;<div class="listclickbox pvmsg">Send Msg</div>&nbsp;<div class="listclickbox clip">Clip</div></div>';
                $(whatString).appendTo(".chatmsgdisp");
                $(".pvmsg").click(function() {
                    var temp = $('<textarea />').html($(this).siblings(".chatde").text()).text();
                    $("#cbx").prop( "checked", true );
                    $("#mentionwho").val(temp);
                });
                $(".clip").click(function() {
                    var putMsg = {
                            msg: $('<textarea />').html($(this).siblings(".chattext").text()).text(),
                            de: $('<textarea />').html($(this).siblings(".chatde").text()).text(),
                            datetime: $('<textarea />').html($(this).siblings(".chatdatetime").text()).text()
                            };
                    genPromptInput(2, 2, putMsg);
                });

            }
            break;
        default:
            if (VaticanCameos){
                kinkyuDashutsuPuroguramu();
            }
            break;
    }
}

function parseUC(data) {
    switch (data.type) {
        case 3:
            handleUInit(data);
            break;
        case 4:
            handleRCreate(data);
            break;
        case 5:
            handleTryRm(data);
            break;
        case 6:
            handleRInit(data);
            break;
        case 7:
            handlePvMsg(data);
            break;
        case 8:
            handleKick(data);
            break;
        case 9:
            handleInvite(data);
            break;
        case 10:
            handleBan(data);
            break;
        case 11:
            handleUnban(data);
            break;
        case 12:
            handleHisMsg(data);
            break;
        case 13:
            handleHashMsg(data);
            break;
        case 14:
            handleClipMsg(data);
            break;
        case 15:
            handlePutClip(data);
            break;
        case 16:
            handleRmvClip(data);
            break;
        case 17:
            handleKinkyuJitai(data);
            break;
        default:
            if (VaticanCameos) {
                kinkyuDashutsuPuroguramu();
            }
            break;
    }
    return;
}

function handleUInit(data) {
    //3
    if (data.type === 3) {
        if ($("#usercheckhistory").length === 0) {      //gen user ctrl
            $("#userctrl").html('<div class="ewrtclickbox" id="usercheckhistory">Check history</div><br /><div class="ewrtclickbox" id="usercheckhashtag">Check hashtag</div><div class="ewrtclickbox" id="usercheckclipboard">Open Clipboard</div><div class="ewrtclickbox" id="signoutbutton">Sign Out</div>');
        }
        $("#usercheckhistory").click(function () {
            tryGetHisMsg(0);
        });
        
		$("#usercheckclipboard").click(function() {
			genPromptInput(2,1,null);
			
		});
		
        $("#usercheckhashtag").click(function () {
            genPromptBoxInput(6);
        });
        
		$("#signoutbutton").click(function() {
			signout();
		});
		$(".rightnotice").text("Hello "+username);
		
        currRoom = "Main Lobby";
        if (currRoom === "Main Lobby") {
            if ($("#createnewroom").length === 0) {
                $("#usercreatenewroom").html('<div class="ewrtclickbox" id="createnewroom">Create new room</div><br />');
                $("#createnewroom").click(function () {
                genPromptBoxInput(1);
                });
            }
            else {
                $("#createnewroom").fadeIn();
            }
        }
        else {
            $("#createnewroom").fadeOut();
        }
        
        parseBC(data);
        var whatString = "";
        for (var i=0;i<data.hisMsg.length;i++) {
            whatString += '<div class="chatmsg"><span class="chattext">';
            whatString += htmlEntities(data.hisMsg[i].msg);
            whatString += '</span><span class="chatdatetime">';
            whatString += htmlEntities(data.hisMsg[i].datetime);
            whatString += '</span><span class="chatde">';
            whatString += htmlEntities(data.hisMsg[i].de);
            whatString += '</span>&emsp;<div class="listclickbox pvmsg">Send Msg</div>&nbsp;<div class="listclickbox clip">Clip</div></div>';
        }
        $(whatString).appendTo(".chatmsgdisp");
        $(".pvmsg").click(function() {
            var temp = $('<textarea />').html($(this).siblings(".chatde").text()).text();
            $("#cbx").prop( "checked", true );
            $("#mentionwho").val(temp);
        });
        $(".clip").click(function() {
            var putMsg = {
                    msg: $('<textarea />').html($(this).siblings(".chattext").text()).text(),
                    de: $('<textarea />').html($(this).siblings(".chatde").text()).text(),
                    datetime: $('<textarea />').html($(this).siblings(".chatdatetime").text()).text()
                    };
            genPromptInput(2, 2, putMsg);
        });
    }
}

function handleRCreate(data) {
    //4
    var whatString = null;
    if (data.type === 4) {
        if (data.createOK === 1) {
            setRoomMCListener(currRoom, data.currRoom);
            currRoom = data.currRoom;
            currRoomMaster = data.roomMaster;
            currRoomToken = data.roomToken;
            //gotoroom room init
            whatString = '<div class="userlistentry"><span class="userinroomname">'+currRoomMaster+'</span><span class="inlinert">Msg</span></div>';
            $(".chatmsgdisp").html("");
            $("#userinroomlist").html(whatString);
            
            
            whatString = "";
            usersinroom = [];
            usersinroom.push(username);
            for (i=0;i<usersinroom.length;i++) {
                whatString += '<option value="'+htmlEntities(usersinroom[i])+'" />';
            }
            $("#mentionwho").html(whatString);
            
            whatString = "";
            whatString = '<div class="ewrtclickbox" id="masterinvite">Invite User</div><br /><div class="ewrtclickbox" id="masterkick">Kick Out User</div><br /><div class="ewrtclickbox" id="masterban">Ban User</div><div class="ewrtclickbox" id="masterunban">Unban User</div>';
            $("#masterctrl").html(whatString);
            $("#masterinvite").click(function () {
                genPromptBoxInput(3);
            });
            $("#masterkick").click(function () {
                genPromptBoxInput(2);
            });
            $("#masterban").click(function () {
                genPromptBoxInput(4);
            });
            $("#masterunban").click(function () {
                genPromptBoxInput(5);
            });
        }
        else {
            showNoteMsg("Create room failure", castToString(data.errmsg));
        }
    }
}

function handleTryRm(data) {
    //5
    if (data.type === 5) {
        if (Number(data.isdenied)===0) {
            setRoomMCListener(currRoom, data.currRoom);
            currRoom = data.currRoom;
            currRoomToken = data.roomToken;
            tryRmInit(currRoom);
        }
        else {
            showNoteMsg("Enter room failure", castToString(data.errmsg));
        }
    }
}

function handleRInit(data) {
    var whatString = "";
    //6
    if (data.type === 6) {
        if (data.currRoom === currRoom) {
            if (currRoom === "Main Lobby") {
                if ($("#createnewroom").length === 0) {
                    $("#usercreatenewroom").html('<div class="ewrtclickbox" id="createnewroom">Create new room</div><br />');
                    $("#createnewroom").click(function () {
                    genPromptBoxInput(1);
                    });
                }
                else {
                    $("#createnewroom").fadeIn();
                }
            }
            else {
                $("#createnewroom").fadeOut();
            }
            currRoomMaster = data.roomMaster;
            if (data.roomMaster === username) {
                whatString = "";
                whatString = '<div class="ewrtclickbox" id="masterinvite">Invite User</div><br /><div class="ewrtclickbox" id="masterkick">Kick Out User</div><br /><div class="ewrtclickbox" id="masterban">Ban User</div><div class="ewrtclickbox" id="masterunban">Unban User</div>';
                $("#masterctrl").html(whatString);
                $("#masterinvite").click(function () {
                    genPromptBoxInput(3);
                });
                $("#masterkick").click(function () {
                    genPromptBoxInput(2);
                });
                $("#masterban").click(function () {
                    genPromptBoxInput(4);
                });
                $("#masterunban").click(function () {
                    genPromptBoxInput(5);
                });
            }
            $(".chatmsgdisp").html("");
            whatString = "";
            for (var i=0;i<data.hisMsg.length;i++) {
                whatString += '<div class="chatmsg"><span class="chattext">';
                whatString += htmlEntities(data.hisMsg[i].msg);
                whatString += '</span><span class="chatdatetime">';
                whatString += htmlEntities(data.hisMsg[i].datetime);
                whatString += '</span><span class="chatde">';
                whatString += htmlEntities(data.hisMsg[i].de);
                whatString += '</span>&emsp;<div class="listclickbox pvmsg">Send Msg</div>&nbsp;<div class="listclickbox clip">Clip</div></div>';
            }
            $(whatString).appendTo(".chatmsgdisp");
            $(".pvmsg").click(function() {
                var temp = $('<textarea />').html($(this).siblings(".chatde").text()).text();
                $("#cbx").prop( "checked", true );
                $("#mentionwho").val(temp);
            });
            $(".clip").click(function() {
                var putMsg = {
                        msg: $('<textarea />').html($(this).siblings(".chattext").text()).text(),
                        de: $('<textarea />').html($(this).siblings(".chatde").text()).text(),
                        datetime: $('<textarea />').html($(this).siblings(".chatdatetime").text()).text()
                        };
                genPromptInput(2, 2, putMsg);
            });
        }
        else {
            showNoteMsg("Room initialization failure", currRoom+" to "+data.currRoom);
        }
    }
}

function handlePvMsg(data) {
    //7
    if (data.type === 7) {
        if (data.roomname === currRoom) {
            var whatString = "";
            whatString += '<div class="pvchatmsg"><span class="chattext">@'+username+":&nbsp;";
            whatString += htmlEntities(data.msg);
            whatString += '</span><span class="chatdatetime">';
            whatString += htmlEntities(data.datetime);
            whatString += '</span><span class="chatde">';
            whatString += htmlEntities(data.de);
            whatString += '</span>&emsp;<div class="listclickbox pvmsg">Send Msg</div>&nbsp;<div class="listclickbox clip">Clip</div></div>';
            $(whatString).appendTo(".chatmsgdisp");
            $(".pvmsg").click(function() {
                var temp = $('<textarea />').html($(this).siblings(".chatde").text()).text();
                $("#cbx").prop( "checked", true );
                $("#mentionwho").val(temp);
            });
            $(".clip").click(function() {
                var putMsg = {
                        msg: $('<textarea />').html($(this).siblings(".chattext").text()).text(),
                        de: $('<textarea />').html($(this).siblings(".chatde").text()).text(),
                        datetime: $('<textarea />').html($(this).siblings(".chatdatetime").text()).text()
                        };
                genPromptInput(2, 2, putMsg);
            });
        }
    }
}

function handleKick(data) {
    //8
    if (data.type === 8) {
        if (data.isKicked === 1) {
            currRoom = "Main Lobby";
            currRoomMaster = null;
            currRoomToken = null;
            $(".chatmsgdisp").html("");
            $("#userinroomlist").html("");
            $("#mentionwho").html("");
            tryGoToRoom(currRoom, null);
            showNoteMsg("You are removed from the room.","");
        }
        else {
            currRoom = data.currRoom;
            currRoomMaster = null;
            currRoomToken = null;
            tryGoToRoom(currRoom, null);
            $(".chatmsgdisp").html("");
            $("#userinroomlist").html("");
            $("#mentionwho").html("");
            showNoteMsg("Sorry, the room master has dismissed the room","");
        }
    }
}

function handleInvite(data) {
    //9
    if (data.type === 9) {
        var whatString = "";
        whatString += '<div class="pvchatmsg"><span class="chattext">@'+username+":&nbsp;";
        whatString += "You are invited to room&nbsp;"+htmlEntities(data.roomname)+"&nbsp;Msg:"+htmlEntities(data.msg);
        whatString += '&nbsp;Inviter:</span><span class="chatde">';
        whatString += htmlEntities(data.inviter)+"&nbsp;";
        whatString += '</span>&emsp;<div class="listclickbox pvmsg">Send Msg</div>&nbsp;<div class="listclickbox clip">Clip</div></div>';
        $(whatString).appendTo(".chatmsgdisp");
        $(".pvmsg").click(function() {
            var temp = $('<textarea />').html($(this).siblings(".chatde").text()).text();
            $("#cbx").prop( "checked", true );
            $("#mentionwho").val(temp);
        });
        $(".clip").click(function() {
            var putMsg = {
                    msg: $('<textarea />').html($(this).siblings(".chattext").text()).text(),
                    de: $('<textarea />').html($(this).siblings(".chatde").text()).text(),
                    datetime: $('<textarea />').html($(this).siblings(".chatdatetime").text()).text()
                    };
            genPromptInput(2, 2, putMsg);
        });
        
        
    }
}

function handleBan(data) {
    //10
    if (data.type === 10) {
        if (data.isBanned === 1) {
            currRoom = "Main Lobby";
            currRoomMaster = null;
            currRoomToken = null;
            $(".chatmsgdisp").html("");
            $("#userinroomlist").html("");
            $("#mentionwho").html("");
            tryGoToRoom(currRoom, null);
            showNoteMsg("You are removed from the room.","Yeah...and also banned.");
        }
    }
}

function handleUnban(data) {
    //11
    if (data.type === 11) {
        if(data.isUnbanned === 1){
            showNoteMsg("You are unbanned from room:"+htmlEntities(data.roomname), "Msg:"+htmlEntities(data.msg));
        }
    }
}

function handleHisMsg(data) {
    //12
    if (data.type === 12) {
        showReadBox(data.hisMsg, data.endat);
    }
}

function handleHashMsg(data) {
    //13
    if (data.type === 13) {
        showReadBox(data.hashMsg, data.endat);
    }
}

function handleClipMsg(data) {
    //14
    if (data.type === 14) {
        showReadBox(data.clipMsg, data.clipMsg.length);
        if (data.errmsg) {
            showNoteMsg(data.errmsg);
        }
    }
}

function handlePutClip(data) {
    //15
    if (data.type === 15) {
        if(data.putOK == 1) {
            showNoteMsg("Message saved", "");
        }
        else {
            showNoteMsg("Saving failed",data.errmsg);
        }
    }
}

function handleRmvClip(data) {
    //16
    if (data.type === 16) {
        if(data.delOK == 1) {
            showNoteMsg("Message deleted", "");
        }
        else {
            showNoteMsg("Delete failed",data.errmsg);
        }
    }
}

function handleKinkyuJitai(data) {//!!!
    //17
    if (data.type === 17) {
        showNoteMsg("Error occurs", data.errmsg);
		if (VaticanCameos) {
			kinkyuDashutsuPuroguramu();
		}
    }
}

function warnFollowUp(warnConfirmed) {      //for self=master && change room exclusive
    if (warnConfirmed) {
        if (gotoWhereIsPublic === 0) {
            genPromptInput(1, gotoWhere, null);
        }
        else {
            tryGoToRoom(gotoWhere, null);
            gotoWhere = null; //!!!
            gotoWhereIsPublic = null;
        }
    }
    else {
        gotoWhereIsPublic = null;
        gotoWhere = null;
    }
}

function signout() {
    socketio.emit("TSvr_signout", {
        username: username,
        prevRm: currRoom
    });
    genLoginSys();
	location.reload();
	window.location.href=window.location.href;
}

function kinkyuDashutsuPuroguramu() {
    if (VaticanCameos) {
        $(".fullcontainer").css("background-color", "#000");
        $(".fullcontainer").html("<!--http://codepen.io/ContemporaryInsanity/pen/RPKVjJ--><canvas id='cvs'></canvas><div class=\"layer5box\" id=\"msgbox\"><div class=\"exitbutton\" id=\"msgBoxClose\">&#10006;</div><div class=\"notetitle\" id=\"msgBoxTitle\"></div><div class=\"notedetail\" id=\"msgBoxDetail\"></div></div>");
        $("#msgbox").css("display", "none");//center
        $("#msgbox").css( "margin-top", "-75px");
        $("#msgbox").css( "margin-left", "-100px");
        $("#msgBoxClose").click(function(event) {
            $("#msgbox").fadeOut();
            event.stopPropagation();
        });
        $("#msgbox").click(function(event) {
            event.stopPropagation();
        });
        cvsi();
        setTimeout(function() {
            signout();
        }, 15000);
    }
}

function genLoginSys() {
    $(".fullcontainer").css("background-color", "#D6D6D6");
    var whatString = '<div class="headtitle">&nbsp;&nbsp; SIGN IN</div><div class="headstrip"></div><div class="bodyblock"><div class="bodybox">'+
'<div id="msgspace"></div><div id="readspace"></div><div id="warnspace"></div><div id="promptspace"></div>'+
'<form id="loginform" method="POST"><p><input class="login" id="inputusername" type="text" name="userinput" placeholder="User Name..." />&nbsp;'+
'<input class="login" id="inputpassword" type="password" name="userinputpw" placeholder="Password..." />&nbsp;'+
'<div class="clickbox" id="loginsubmit">LOGIN</div>&emsp;<div class="clickbox" id="signinsubmit">SIGNUP</div>'+
'</p></form></div>'+'<br/><br/><br/><br/></div>';
    $(".fullcontainer").html(whatString);
    username = null;
    listenToHail = null;
    listenToBC = "TC_update";
    listenToMC = null;
    currRoom = null;
}

function genChatSys() {
    $(".headtitle").text('  CHAT ROOM');
    $(".bodybox").html('<div id="msgspace"></div><div id="readspace"></div><div id="warnspace"></div><div id="promptspace"></div><div class="mainbox"></div><div class="rightbox"></div>');
    $(".mainbox").html('<div class="chatmsgdisp"></div><div class="chatterbox"><form method="post"><textarea class="eventeditordescription" id="chattertext" placeholder="Send a message..."></textarea><div class="eventeditordatetimebg"><!--cbx code adopted from http://codepen.io/andreasstorm/pen/JbXKob--><label>Send private message?</label>&emsp;<input type="checkbox" id="cbx" class="cbx hidden cbxbox"/><label for="cbx" class="lbl cbxbox"></label><br /><input type="text" class="smlogin" id="mentionwho" list="uirlist"><datalist id="uirlist" class="inputuirlist"></datalist></div><div class="clickbox" id="chattersubmit">Submit</div></form></div>');
    $(".rightbox").html('<div class="rightnotice"></div> <br /> <div class="roomlist" id="roomlist"></div> <br /><div class="rightchangefield"></div><br /> <div class="userlist" id="userinroomlist"></div> <div class="userlist" id="alluserlist"></div><div class="userctrl" id="masterctrl"></div><div class="userctrl" id="userctrl"></div><div class="userctrl" id="usercreatenewroom"></div>');
    $("#msgspace").html("<div class=\"layer5box\" id=\"msgbox\"><div class=\"exitbutton\" id=\"msgBoxClose\">&#10006;</div><div class=\"notetitle\" id=\"msgBoxTitle\"></div><div class=\"notedetail\" id=\"msgBoxDetail\"></div></div>");
    $("#readspace").html('<div class="layer4box fixcenter" id="readbox"><div class="exitbutton" id="readBoxClose">&#10006;</div><div class="readlist" id="readlist"></div><div class="readlistctrl" id="readlistctrl"><div class="clickbox" id="lastpagebutton"><div class="revarrow"></div></div><div class="clickbox" id="nextpagebutton"><div class="fwdarrow"></div></div></div></div>');
    $("#warnspace").html('<div class="warnbox fixcenter" id="warnbox"><div class="notetitle" id="warntitle"></div><br /><br /><div class="clickbox" id="warnok">&nbsp;&nbsp;OK&nbsp;&nbsp;</div>&emsp;<div class="clickbox" id="warncancel">CANCEL</div></div>');       //callback for button click
    $("#promptspace").html('<div class="layer4box fixcenter" id="promptbox"><div class="exitbutton" id="promptBoxClose">&#10006;</div><div class="promptboxcontent" id="promptboxcontent"></div></div>');
    $("#msgbox").css("display", "none");
    $(".rightchangefield").css("display", "none");
    //$("#msgbox").css( "margin-top", "-75px");
    //$("#msgbox").css( "margin-left", "-100px");
    $("#readbox").css("display", "none");           //600*450
    $("#readbox").css( "margin-top", "-100px");
    $("#readbox").css( "margin-left", "-300px");
    $("#warnbox").css("display", "none");           //400*300
    $("#warnbox").css( "margin-top", "-100px");
    $("#warnbox").css( "margin-left", "-200px");
    $("#promptbox").css("display", "none");           //600*450
    $("#promptbox").css( "margin-top", "-125px");
    $("#promptbox").css( "margin-left", "-300px");
    
    //add action
	$("#chattersubmit").click(function() {
		var msg = "";
		var isPrivate = 0;
		var towho = null;
		if ($("#chattertext").val()) {
			if ($("#cbx").prop( "checked" ) && $("#mentionwho").val()) {
				isPrivate = 1;
				towho = castToString($("#mentionwho").val());
			}
			msg = castToString($("#chattertext").val());
			trySpeak(msg, isPrivate, towho);
		}
		
		});
	
	$("#cbx").change(function() {
		if ($("#cbx").prop("checked")) {
			$("#mentionwho").fadeIn();
		}
		else {
			$("#mentionwho").fadeOut();
		}
	});
	
	
    $("#msgBoxClose").click(function(event) {
        $("#msgbox").fadeOut();
        event.stopPropagation();
    });
    $("#msgbox").click(function(event) {
        event.stopPropagation();
    });
    $("#readBoxClose").click(function(event) {
        $("#readbox").fadeOut();
        event.stopPropagation();
    });
    $("#readbox").click(function(event) {
        event.stopPropagation();
    });
    $("#warncancel").click(function(event) {
        warnFollowUp(false);
        $("#warnbox").fadeOut();
        event.stopPropagation();
    });
    $("#warnok").click(function(event) {
        warnFollowUp(true);
        $("#warnbox").fadeOut();
        event.stopPropagation();
    });
    $("#warnbox").click(function(event) {
        event.stopPropagation();
    });
    $("#promptBoxClose").click(function(event) {
        $("#promptbox").fadeOut();
        event.stopPropagation();
    });
    $("#promptbox").click(function(event) {
        event.stopPropagation();
    });

}

function genPromptBoxInput(whichOne) {
    var insertWhat = "";
    var i = 0;
    switch (whichOne) {
        case 1:
            insertWhat = '<p>Room name should be longer than 5 charactors</p><form method="post"><input type="text" class="promptinput" id="createroomname" placeholder="Room name..."/>'+
'<input type="password" class="promptinput" id="createroompwd" placeholder="Room password..." />'+
'<label>Leave out password field to create public room.</label><label>A legal password should be longer than 10 charactors.</label>'+
'<div class="clickbox" id="createroomsubmit">SUBMIT</div></form>';
            $("#promptboxcontent").html(insertWhat);
			$("#promptbox").fadeIn();
            $("#createroomsubmit").click(function() {
                if ($("#createroomname").val().length > 5) {
                    if ($("#createroompwd").val()) {
                        if ($("#createroompwd").val().length > 10) {
                            tryCreateRm(castToString($("#createroomname").val()), 0, castToString($("#createroompwd").val()));
                            $("#promptbox").fadeOut();
                        }
                        else {
                            showNoteMsg("Please consider a longer password.", "A legal password should be longer than 10 charactors.");
                        }
                    }
                    else {
                        tryCreateRm(castToString($("#createroomname").val()), 1, null);
                        $("#promptbox").fadeOut();
                    }
                }
            });
            break;
        case 2:
            insertWhat = '<form method="post"><input type="text" class="promptinput" id="kickwho" list="uirkicklist"><datalist id="uirkicklist" class="inputuirlist">';
            for (i=0;i<usersinroom.length;i++) {
                insertWhat += '<option value="'+htmlEntities(usersinroom[i])+'" />';
            }
            insertWhat += '</datalist><div class="clickbox" id="kicksubmit">SUBMIT</div></form>';
            $("#promptboxcontent").html(insertWhat);
			$("#promptbox").fadeIn();
            $("#kicksubmit").click(function() {
                if ($("#kickwho").val().length > 3) {
                    tryKick(castToString($("#kickwho").val()));
                    $("#promptbox").fadeOut();
                }
                else {
                    showNoteMsg("Please enter a valid user name", "");
                }
            });
            break;
        case 3:
            insertWhat = '<form method="post"><input type="text" class="promptinput" id="invitewho" list="auinvitelist"><datalist id="auinvitelist" class="inputuirlist">';
            for (i=0;i<allusers.length;i++) {
                insertWhat += '<option value="'+htmlEntities(allusers[i])+'" />';
            }
            insertWhat += '</datalist><input type="text" class="promptinput" id="invitemsg" /><div class="clickbox" id="invitesubmit">SUBMIT</div></form>';
            $("#promptboxcontent").html(insertWhat);
			$("#promptbox").fadeIn();
            $("#invitesubmit").click(function() {
                if ($("#invitewho").val().length > 3) {
                    tryInvite(castToString($("#invitewho").val()), castToString($("#invitemsg").val()));
                    $("#promptbox").fadeOut();
                }
                else {
                    showNoteMsg("Please enter a valid user name", "");
                }
            });
            break;
        case 4:
            insertWhat = '<form method="post"><input type="text" class="promptinput" id="banwho" list="aubanlist"><datalist id="aubanlist" class="inputuirlist">';
            for (i=0;i<allusers.length;i++) {
                insertWhat += '<option value="'+htmlEntities(allusers[i])+'" />';
            }
            insertWhat += '</datalist><div class="clickbox" id="bansubmit">SUBMIT</div></form>';
            $("#promptboxcontent").html(insertWhat);
			$("#promptbox").fadeIn();
            $("#bansubmit").click(function() {
                if ($("#banwho").val().length > 3) {
                    tryBan(castToString($("#banwho").val()));
                    banlist.push(castToString($("#banwho").val()));
                    $("#promptbox").fadeOut();
                }
                else {
                    showNoteMsg("Please enter a valid user name", "");
                }
            });
            break;
        case 5:
            insertWhat = '<form method="post"><input type="text" class="promptinput" id="unbanwho" list="unbanlist"><datalist id="unbanlist" class="inputuirlist">';
            for (i=0;i<banlist.length;i++) {
                insertWhat += '<option value="'+htmlEntities(banlist[i])+'" />';
            }
            insertWhat += '</datalist><input type="text" class="promptinput" id="unbanmsg" /><div class="clickbox" id="unbansubmit">SUBMIT</div></form>';
            $("#promptboxcontent").html(insertWhat);
			$("#promptbox").fadeIn();
            $("#unbansubmit").click(function() {
                if ($("#unbanwho").val().length > 3) {
                    tryUnban(castToString($("#unbanwho").val()), castToString($("#unbanmsg").val()));
                    $("#promptbox").fadeOut();
                    for (var j=0;j<banlist.length;j++) {
                        if (banlist[j]===castToString($("#unbanwho").val())) {
                            banlist.splice(j, 1);
                        }
                    }
                }
                else {
                    showNoteMsg("Please enter a valid user name", "");
                }
            });
            break;
        case 6:
            insertWhat = '<form method="post"><label>#</label><input type="text" class="promptinput" id="hashtagmsg" /><label>#</label><br /><div class="clickbox" id="hashtagsubmit">SUBMIT</div></form>';
            $("#promptboxcontent").html(insertWhat);
			$("#promptbox").fadeIn();
            $("#hashtagsubmit").click(function() {
                var hashtagmsg = castToString($("#hashtagmsg").val()).replace(/#/g,'');
                if (hashtagmsg.length > 0) {
                    tryGetHashMsg(hashtagmsg,0);
                    $("#promptbox").fadeOut();
                }
                else {
                    showNoteMsg("Please enter a valid value inside the hashtags", "");
                }
            });
            break;
        default:
            break;
    }
}

function genPromptInput(whichOne, whatString, whatMsg) {    //type multifunc msgobj/id
    var insertWhat = "";
    var targetRm = $('<textarea />').html(whatString).text();
    if (whichOne === 1) {
        insertWhat = '<form method="post"><label id="gotoindicator">Enter password for room'+htmlEntities(whatString)+'</label><br /><input type="password" class="smlogin" id="roompwd" placeholder="Room password..." /><div class="ewrtclickbox" id="gotoroombutton">Go to room</div></form>';
        $(".rightchangefield").html(insertWhat);
        $(".rightchangefield").fadeIn(100).fadeOut(100).fadeIn(100).fadeOut(100).fadeIn();
        $("#gotoroombutton").click(function () {
            if ($("#roompwd").val()) {
                tryGoToRoom(targetRm, castToString($("#roompwd").val()));
                gotoWhere = null;//!!!
                gotoWhereIsPublic = null;
            }
            else {
                showNoteMsg('Please enter the room password.', "");
            }
        });
    }
    else if (whichOne === 2){
        insertWhat = '<form method="post"><label id="gotoindicator">Please enter your password:</label><br /><input type="password" class="smlogin" id="userpwd" placeholder="Enter password..." /><div class="ewrtclickbox" id="gotoclipboard">Access clips</div></form>';
        $(".rightchangefield").html(insertWhat);
        $(".rightchangefield").fadeIn(100).fadeOut(100).fadeIn(100).fadeOut(100).fadeIn();
        $("#gotoclipboard").click(function () {
            if ($("#userpwd").val()) {
                var t_password = castToString($("#userpwd").val());
                t_password += t_password.split('').reverse().join('');
                t_password = md5(t_password);
                switch (whatString) {
                    case 1:
                        tryGetClipBoard(t_password);
                        break;
                    case 2:
                        tryPutClipBoard(whatMsg, t_password);       //!!!if this doesnt work then use global
                        break;
                    case 3:
                        tryRmClipBoard(whatMsg, t_password);
                        break;
                    default:
                        showNoteMsg("Wrong type/format", "");
                        break;
                }
            }
            else {
                showNoteMsg('Please enter your password to access clipboard.', "");
            }
        });
    }
    
}//!!!expect reply paramenter?


$("#loginsubmit").click(function() {
    socketio.removeAllListeners(listenToHail);
    socketio.removeAllListeners(listenToBC);
    socketio.removeAllListeners(listenToMC);
    if ($("#inputpassword").val() && $("#inputusername").val()) {
        if ($("#inputpassword").val().length > 10 && $("#inputusername").val().length > 5) {
            //login
            var t_username = castToString($("#inputusername").val());
            var t_password = castToString($("#inputpassword").val());
            username = "";
            username = t_username;
            listenToHail = "tHail_"+t_username;
            t_password += t_password.split('').reverse().join('');      ////is there such thing as a salted md5?
            t_password = md5(t_password);       // what are the chances that 2 64 bit md5 collide? dunno duncare...
            
            socketio.emit("TSvr_login", {
                username: t_username,
                password: t_password
            });
            
            socketio.on(listenToHail, function(data) {
                var warnmsg = null;
                if (data.type === 1) {
                    if (data.loginOK === 1) {
                        hideWarnMsg();
                        username = t_username;
                        socketio.removeAllListeners(listenToHail);
                        initOnLoginOK();
                    }
                    else {
                        warnmsg = "User name and password do not match our record";
                        showWarnMsg(warnmsg);
                    }
                }
            });
            
            
        }
    }
    
});

$("#signinsubmit").click(function() {           //remember to benchmark fps on mh00w2lla
    var pwagain = $("#pwsuagain");
    var warnmsg = null;
    $("#loginsubmit").fadeOut();
    socketio.removeAllListeners(listenToHail);
    socketio.removeAllListeners(listenToBC);
    socketio.removeAllListeners(listenToMC);
    if (pwagain.length) {
        if (pwagain.val() && $("#inputusername").val() && $("#inputpassword").val()) {
            if ($("#inputusername").val().length > 5 && $("#inputpassword").val().length > 10 && (/^[a-zA-Z0-9]+$/.test($("#inputusername").val()))) {
                if ($("#inputpassword").val() === pwagain.val()) {
                    //signup
                    username = "";
					t_username = castToString($("#inputusername").val());
					t_password = castToString($("#inputpassword").val());
                    username = t_username;
                    t_password += t_password.split('').reverse().join('');
                    t_password = md5(t_password);
                    listenToHail = "tHail_"+t_username;
                    socketio.emit("TSvr_signup", {
                        username: t_username,
                        password: t_password
                    });
                    
                    socketio.on(listenToHail, function(data) {
                        if (data.type === 2) {
                            if (data.signupOK === 1) {
                                hideWarnMsg();
                                username = t_username;
                                socketio.removeAllListeners(listenToHail);
                                initOnLoginOK();
                            }
                            else {
                                showWarnMsg("User already exists.");
                            }
                        }
                    });
                }
                else {
                    warnmsg = "Passwords are different";
                }
            }
            else {
                warnmsg = "Username should be alphanumeric and longer than 5. Password length should be longer than 10";
            }
        }
        else {
            warnmsg = "Missing field";
        }
        if (warnmsg) {
            showWarnMsg(warnmsg);
        }
        
    }
    else {
        $("#loginform").append('<input type="password" class="login" id="pwsuagain" placeholder="ReEnter Password..."/><br /><label class="eventeditorlable" id="smrtnote">All fields need to be alphanumeric and longer than 5 bits.</label>');
    }
});

function showWarnMsg(warnMsg) {
    if (!$(".notice").length) {
        $( '<div class="notice"><div>' ).prependTo(".bodybox");
    }
    $(".notice").text(warnMsg);//warn msg
    return;
}

function showNoteMsg(whatTitle, whatDetail) {
    $("#msgbox").fadeIn();
    $("#msgBoxTitle").text(castToString(whatTitle));
    $("#msgBoxDetail").text(castToString(whatDetail));
}

function showWarnBox(whatTitle) {
    $("#warnbox").fadeIn();
    $("#notetitle").text(castToString(whatTitle));
}

function showReadBox(whatMsgs, endat) {
    var whatString = "";
    for(var i=0; i<whatMsgs.length; i++) {
        if (typeof(whatMsgs[i].id)!=="undefined"){
        
        whatString += '<div class="smchatmsg"><div class="clipid hidden">'+whatMsgs[i].id+'</div><span class="chattext">';
        }
        else {
            whatString += '<div class="smchatmsg"><span class="chattext">';
        }
        whatString += htmlEntities(whatMsgs[i].msg);
        whatString += '</span><span class="chatdatetime">';
        whatString += htmlEntities(whatMsgs[i].datetime);
        whatString += '</span><span class="chatde">';
        whatString += htmlEntities(whatMsgs[i].de);
        whatString += '</span>';
        if (typeof(whatMsgs[i].id)!=="undefined"){
            whatString += '<div class="listclickbox userremoveclip">remove</div>';
        }
        whatString += '</div>';
    }
    $("#readlist").html(whatString);
	$("#readbox").fadeIn();
    $("#nextpagebutton").click(function() {
        tryGetHisMsg(endat);
    });
    if (whatMsgs.length<100) {
        $("#nextpagebutton").attr('disabled', 'disabled');
    }
    else {
        $("#nextpagebutton").removeAttr('disabled');
    }
    $("#lastpagebutton").click(function() {
        tryGetHisMsg(0);
    });
    if (typeof(whatMsgs[0])!=="undefined"){
		if (typeof(whatMsgs[0].id)!=="undefined"){
			$(".userremoveclip").click(function() {
				var id = $(this).siblings(".clipid").text();
				genPromptInput(2, 3, id);
				$("#readbox").fadeOut();
			});
			$("#nextpagebutton").fadeOut();
			$("#lastpagebutton").fadeOut();
		}
    }else{
        $("#nextpagebutton").fadeIn();
        $("#lastpagebutton").fadeIn();
    }
    
    //!!!need to wire up page sys outside
}

function hideWarnMsg() {
    if ($(".notice").length) {
        $(".notice").remove();
    }
    return;
}
	
    
function htmlEntities(stringToCleanse) {
    if (stringToCleanse){
        return castToString(stringToCleanse).replace(/'/g, '&#039;').replace(/"/g, '&quot;').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    else {
        return null;
    }
}
    
    
    
//i just have a really bad feeling putting cleartext password in public socket... its not that hard to intercept... gotta put a protection somehow
//I read an article about never let some unknown website host your external js so I decided to paste them here It just make sense...
//what happen to the simpler times when people just trust each others... sigh
//All MD5 code by Joseph Myers http://www.myersdaily.org/joseph/javascript/md5-text.html
function md5cycle(x, k) {
var a = x[0], b = x[1], c = x[2], d = x[3];

a = ff(a, b, c, d, k[0], 7, -680876936);
d = ff(d, a, b, c, k[1], 12, -389564586);
c = ff(c, d, a, b, k[2], 17,  606105819);
b = ff(b, c, d, a, k[3], 22, -1044525330);
a = ff(a, b, c, d, k[4], 7, -176418897);
d = ff(d, a, b, c, k[5], 12,  1200080426);
c = ff(c, d, a, b, k[6], 17, -1473231341);
b = ff(b, c, d, a, k[7], 22, -45705983);
a = ff(a, b, c, d, k[8], 7,  1770035416);
d = ff(d, a, b, c, k[9], 12, -1958414417);
c = ff(c, d, a, b, k[10], 17, -42063);
b = ff(b, c, d, a, k[11], 22, -1990404162);
a = ff(a, b, c, d, k[12], 7,  1804603682);
d = ff(d, a, b, c, k[13], 12, -40341101);
c = ff(c, d, a, b, k[14], 17, -1502002290);
b = ff(b, c, d, a, k[15], 22,  1236535329);

a = gg(a, b, c, d, k[1], 5, -165796510);
d = gg(d, a, b, c, k[6], 9, -1069501632);
c = gg(c, d, a, b, k[11], 14,  643717713);
b = gg(b, c, d, a, k[0], 20, -373897302);
a = gg(a, b, c, d, k[5], 5, -701558691);
d = gg(d, a, b, c, k[10], 9,  38016083);
c = gg(c, d, a, b, k[15], 14, -660478335);
b = gg(b, c, d, a, k[4], 20, -405537848);
a = gg(a, b, c, d, k[9], 5,  568446438);
d = gg(d, a, b, c, k[14], 9, -1019803690);
c = gg(c, d, a, b, k[3], 14, -187363961);
b = gg(b, c, d, a, k[8], 20,  1163531501);
a = gg(a, b, c, d, k[13], 5, -1444681467);
d = gg(d, a, b, c, k[2], 9, -51403784);
c = gg(c, d, a, b, k[7], 14,  1735328473);
b = gg(b, c, d, a, k[12], 20, -1926607734);

a = hh(a, b, c, d, k[5], 4, -378558);
d = hh(d, a, b, c, k[8], 11, -2022574463);
c = hh(c, d, a, b, k[11], 16,  1839030562);
b = hh(b, c, d, a, k[14], 23, -35309556);
a = hh(a, b, c, d, k[1], 4, -1530992060);
d = hh(d, a, b, c, k[4], 11,  1272893353);
c = hh(c, d, a, b, k[7], 16, -155497632);
b = hh(b, c, d, a, k[10], 23, -1094730640);
a = hh(a, b, c, d, k[13], 4,  681279174);
d = hh(d, a, b, c, k[0], 11, -358537222);
c = hh(c, d, a, b, k[3], 16, -722521979);
b = hh(b, c, d, a, k[6], 23,  76029189);
a = hh(a, b, c, d, k[9], 4, -640364487);
d = hh(d, a, b, c, k[12], 11, -421815835);
c = hh(c, d, a, b, k[15], 16,  530742520);
b = hh(b, c, d, a, k[2], 23, -995338651);

a = ii(a, b, c, d, k[0], 6, -198630844);
d = ii(d, a, b, c, k[7], 10,  1126891415);
c = ii(c, d, a, b, k[14], 15, -1416354905);
b = ii(b, c, d, a, k[5], 21, -57434055);
a = ii(a, b, c, d, k[12], 6,  1700485571);
d = ii(d, a, b, c, k[3], 10, -1894986606);
c = ii(c, d, a, b, k[10], 15, -1051523);
b = ii(b, c, d, a, k[1], 21, -2054922799);
a = ii(a, b, c, d, k[8], 6,  1873313359);
d = ii(d, a, b, c, k[15], 10, -30611744);
c = ii(c, d, a, b, k[6], 15, -1560198380);
b = ii(b, c, d, a, k[13], 21,  1309151649);
a = ii(a, b, c, d, k[4], 6, -145523070);
d = ii(d, a, b, c, k[11], 10, -1120210379);
c = ii(c, d, a, b, k[2], 15,  718787259);
b = ii(b, c, d, a, k[9], 21, -343485551);

x[0] = add32(a, x[0]);
x[1] = add32(b, x[1]);
x[2] = add32(c, x[2]);
x[3] = add32(d, x[3]);

}

function cmn(q, a, b, x, s, t) {
a = add32(add32(a, q), add32(x, t));
return add32((a << s) | (a >>> (32 - s)), b);
}

function ff(a, b, c, d, x, s, t) {
return cmn((b & c) | ((~b) & d), a, b, x, s, t);
}

function gg(a, b, c, d, x, s, t) {
return cmn((b & d) | (c & (~d)), a, b, x, s, t);
}

function hh(a, b, c, d, x, s, t) {
return cmn(b ^ c ^ d, a, b, x, s, t);
}

function ii(a, b, c, d, x, s, t) {
return cmn(c ^ (b | (~d)), a, b, x, s, t);
}

function md51(s) {
txt = '';
var n = s.length,
state = [1732584193, -271733879, -1732584194, 271733878], i;
for (i=64; i<=s.length; i+=64) {
md5cycle(state, md5blk(s.substring(i-64, i)));
}
s = s.substring(i-64);
var tail = [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0];
for (i=0; i<s.length; i++)
tail[i>>2] |= s.charCodeAt(i) << ((i%4) << 3);
tail[i>>2] |= 0x80 << ((i%4) << 3);
if (i > 55) {
md5cycle(state, tail);
for (i=0; i<16; i++) tail[i] = 0;
}
tail[14] = n*8;
md5cycle(state, tail);
return state;
}

/* there needs to be support for Unicode here,
 * unless we pretend that we can redefine the MD-5
 * algorithm for multi-byte characters (perhaps
 * by adding every four 16-bit characters and
 * shortening the sum to 32 bits). Otherwise
 * I suggest performing MD-5 as if every character
 * was two bytes--e.g., 0040 0025 = @%--but then
 * how will an ordinary MD-5 sum be matched?
 * There is no way to standardize text to something
 * like UTF-8 before transformation; speed cost is
 * utterly prohibitive. The JavaScript standard
 * itself needs to look at this: it should start
 * providing access to strings as preformed UTF-8
 * 8-bit unsigned value arrays.
 */
function md5blk(s) { /* I figured global was faster.   */
var md5blks = [], i; /* Andy King said do it this way. */
for (i=0; i<64; i+=4) {
md5blks[i>>2] = s.charCodeAt(i) + (s.charCodeAt(i+1) << 8) + (s.charCodeAt(i+2) << 16) + (s.charCodeAt(i+3) << 24);
}
return md5blks;
}

var hex_chr = '0123456789abcdef'.split('');

function rhex(n)
{
var s='', j=0;
for(; j<4; j++)
s += hex_chr[(n >> (j * 8 + 4)) & 0x0F] + hex_chr[(n >> (j * 8)) & 0x0F];
return s;
}

function hex(x) {
for (var i=0; i<x.length; i++)
x[i] = rhex(x[i]);
return x.join('');
}

function md5(s) {
return hex(md51(s));
}

/* this function is much faster,
so if possible we use it. Some IEs
are the only ones I know of that
need the idiotic second function,
generated by an if clause.  */

function add32(a, b) {
return (a + b) & 0xFFFFFFFF;
}

if (md5('hello') != '5d41402abc4b2a76b9719d911017c592') {
function add32(x, y) {
var lsw = (x & 0xFFFF) + (y & 0xFFFF),
msw = (x >> 16) + (y >> 16) + (lsw >> 16);
return (msw << 16) | (lsw & 0xFFFF);
}
}

function cvsi() {
    $("#msgBoxTitle").text("Socket package corrupted. Reloading...");
    $("#msgBoxDetail").text("Please use smart wording to charge. Enjoy.");
    //Code from http://codepen.io/ContemporaryInsanity/pen/RPKVjJ
    // Get canvas
    var cvs = document.getElementById('cvs');
    
    // Canvas fills window
    cvs.height = window.innerHeight;
    cvs.width = window.innerWidth;
    
    // Get canvas context
    var ctx = cvs.getContext('2d');
    
    // Set font, size & number of columns
    var font = 'arial';
    var fontSize = 10;
    ctx.font = fontSize + 'px ' + font;
    var cols = cvs.width / fontSize;
    
    // Characters
    var charSet;
    charSet = '0123456789ABCDEF'; // Hex
    charSet = charSet.split(''); // Convert string to array
    
    // One drop per column, row set randomly
    var drops = [];
    for (var col = 0; col < cols; col++)
      drops[col] = Math.floor(Math.random() * cvs.height);
    
    // Call rain() every 25ms
    setInterval(rain, 25);
    
    function rain() {
      // Background, black, translucent
      /* This is key to the fade effect, clear the window with an alpha of 0.05, which doesn't clear it entirely but leaves existing text progressively dimmed with each subsequent call to rain()
       */
      ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
      ctx.fillRect(0, 0, cvs.width, cvs.height);
      
      // For each column / drop
      for (var col = 0; col < drops.length; col++) {
        // Pick a random char
        var char = charSet[Math.floor(Math.random() * charSet.length)];
        // Pick a random colour
        ctx.fillStyle = randColour();
        // Draw the char
        ctx.fillText(char, col * fontSize, drops[col] * fontSize);
        // Randomly reset drop back to top row
        if (Math.random() > 0.99)
          drops[col] = 0;
    
        drops[col]++; // Move drop down a row
      }
    }
    
    function randColour()
    {
      return'rgb(' + 
        Math.floor(Math.random() * 256) + ',' + 
        Math.floor(Math.random() * 256) + ',' + 
        Math.floor(Math.random() * 256) + ')';
    }
}

function castToString(what) {
        if (typeof(what)!== "number")  {
                if (what) {
                        return String(what);
                }else {
                        return what;
                }
        }
        else {
                return String(what);
        }
}
	
</script>
</body>
</html>
